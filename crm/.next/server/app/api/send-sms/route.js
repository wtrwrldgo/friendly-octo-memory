"use strict";(()=>{var e={};e.id=2245,e.ids=[2245],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8514:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>m,patchFetch:()=>g,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>S});var r={};s.r(r),s.d(r,{POST:()=>l});var n=s(9303),o=s(8716),i=s(670),a=s(7070);class c{constructor(){this.token=null,this.tokenExpiration=0,this.baseUrl="https://notify.eskiz.uz/api"}static getInstance(){return c.instance||(c.instance=new c),c.instance}async getToken(){let e=process.env.ESKIZ_EMAIL,t=process.env.ESKIZ_PASSWORD;if(!e||!t)throw Error("ESKIZ_EMAIL and ESKIZ_PASSWORD environment variables are not set.");if(this.token&&Date.now()<this.tokenExpiration)return this.token;try{console.log(`[EskizService] Authenticating with email: ${e}`);let s=await fetch(`${this.baseUrl}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),r=await s.json();if(!s.ok)throw console.error("[EskizService] Authentication Failed:",r),Error(r.message||"Failed to authenticate with Eskiz.uz");return this.token=r.data.token,this.tokenExpiration=Date.now()+25056e5,console.log("[EskizService] Authentication successful. Token obtained."),this.token}catch(e){throw console.error("[EskizService] Auth Error:",e.message),e}}async sendSMS(e,t){try{console.log(`[EskizService] Attempting to send SMS to ${e}`);let s=await this.getToken(),r=e.replace(/\D/g,"");console.log(`[EskizService] Formatted phone: ${r}`);let n=new FormData;n.append("mobile_phone",r),n.append("message",t),n.append("from","4546");let o=await fetch(`${this.baseUrl}/message/sms/send`,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:n}),i=await o.json();if(!o.ok)return console.error("[EskizService] Send SMS API Error:",JSON.stringify(i,null,2)),i.message&&i.message.includes("Limit")&&console.error("[EskizService] CRITICAL: SMS Limit Exceeded"),!1;return console.log("[EskizService] SMS Sent Successfully. Response:",JSON.stringify(i,null,2)),!0}catch(e){return console.error("[EskizService] Send SMS Exception:",e.message),e.cause&&console.error("Cause:",e.cause),!1}}}let u=c.getInstance();async function l(e){try{let{phone:t,code:s}=await e.json();if(!t||!s)return a.NextResponse.json({success:!1,error:"Phone number and code are required."},{status:400});let r=`Your confirmation code for WaterGo: ${s}`;if(process.env.ESKIZ_EMAIL,await u.sendSMS(t,r))return a.NextResponse.json({success:!0,message:"SMS sent successfully"});return a.NextResponse.json({success:!1,error:"Failed to send SMS via provider."},{status:500})}catch(e){return console.error("API Error sending SMS:",e),a.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/send-sms/route",pathname:"/api/send-sms",filename:"route",bundlePath:"app/api/send-sms/route"},resolvedPagePath:"/Users/musabekisakov/claudeCode/crm/app/api/send-sms/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:S,serverHooks:h}=d,m="/api/send-sms/route";function g(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:S})}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>s(8514));module.exports=r})();