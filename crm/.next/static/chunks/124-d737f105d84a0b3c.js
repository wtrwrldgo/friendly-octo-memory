"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[124],{6281:function(e,t,r){r.d(t,{AuthProvider:function(){return d},a:function(){return c}});var n=r(7437),a=r(2265),o=r(9376);let i="/api",l=(0,a.createContext)(void 0);function d(e){let{children:t}=e,[r,d]=(0,a.useState)(null),[c,s]=(0,a.useState)(null),[u,m]=(0,a.useState)(null),[v,h]=(0,a.useState)(!0),f=(0,o.useRouter)();(0,o.usePathname)(),(0,a.useEffect)(()=>{let e=localStorage.getItem("auth_token"),t=localStorage.getItem("auth_user"),r=localStorage.getItem("auth_firm");e&&t&&(m(e),d(JSON.parse(t)),r&&s(JSON.parse(r))),h(!1)},[]);let g=async()=>{d(null),s(null),m(null),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),localStorage.removeItem("auth_firm"),localStorage.removeItem("userType"),localStorage.removeItem("userEmail"),localStorage.removeItem("firmId"),document.cookie="auth-token=; path=/; max-age=0",f.push("/login")},p={user:r,profile:r,token:u,loading:v,signIn:async(e,t)=>{try{console.log("Signing in with API_URL:",i);let r=await fetch("".concat(i,"/auth/staff/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});console.log("Response status:",r.status);let n=await r.json();if(console.log("Response data:",n),!r.ok)throw Error(n.message||"Invalid email or password");let{token:a,user:o,firm:l}=n.data;return m(a),d(o),s(l),localStorage.setItem("auth_token",a),localStorage.setItem("auth_user",JSON.stringify(o)),l&&localStorage.setItem("auth_firm",JSON.stringify(l)),document.cookie="auth-token=".concat(a,"; path=/; max-age=").concat(2592e3),localStorage.setItem("userType","WATERGO_ADMIN"===o.role?"admin":"firm"),localStorage.setItem("userEmail",o.email),o.firmId&&localStorage.setItem("firmId",o.firmId),{error:null,user:o}}catch(e){return console.error("Sign in error:",e),{error:e}}},signOut:g,logout:g,isOwner:(null==r?void 0:r.role)==="OWNER",isManager:(null==r?void 0:r.role)==="MANAGER",isOperator:(null==r?void 0:r.role)==="OPERATOR",isWatergoAdmin:(null==r?void 0:r.role)==="WATERGO_ADMIN",canAccessAllBranches:(null==r?void 0:r.role)==="OWNER"||(null==r?void 0:r.role)==="WATERGO_ADMIN",firm:c,updateFirm:e=>{if(c){let t={...c,...e};s(t),localStorage.setItem("auth_firm",JSON.stringify(t))}}};return(0,n.jsx)(l.Provider,{value:p,children:t})}function c(){let e=(0,a.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},7124:function(e,t,r){r.d(t,{FirmDataProvider:function(){return d},R:function(){return c}});var n=r(7437),a=r(2265),o=r(6281),i=r(2507);let l=(0,a.createContext)(void 0);function d(e){let{children:t}=e,{user:r,firm:d}=(0,o.a)(),[c,s]=(0,a.useState)([]),[u,m]=(0,a.useState)(!1),v=(0,a.useRef)(0),[h,f]=(0,a.useState)([]),[g,p]=(0,a.useState)(!1),y=(0,a.useRef)(0),[S,I]=(0,a.useState)([]),[N,_]=(0,a.useState)(!1),b=(0,a.useRef)(0),O=(null==r?void 0:r.firmId)||(null==d?void 0:d.id),k=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!O)return;let t=Date.now();if(e||!(c.length>0)||!(t-v.current<3e5))try{m(!0);let{data:e,error:r}=await i.db.getOrders(O);if(r){console.error("Failed to fetch orders:",r);return}if(e){let r=e.map(e=>{var t,r,n,a,o,i,l,c,s,u,m,v;return{id:e.id,orderNumber:e.orderNumber||e.order_number||"WG-".concat(new Date().getFullYear(),"-000000"),firmId:e.firmId||e.firm_id,firmName:(null===(t=e.firm)||void 0===t?void 0:t.name)||e.firmName||(null==d?void 0:d.name)||"",clientName:(null===(r=e.user)||void 0===r?void 0:r.name)||e.clientName||(null===(n=e.users)||void 0===n?void 0:n.name)||(null===(a=e.user)||void 0===a?void 0:a.phone)||"Unknown Client",address:(null===(o=e.address)||void 0===o?void 0:o.address)||e.addressText||e.address||"",status:e.stage||e.status||"PENDING",paymentMethod:e.paymentMethod||e.payment_method||"CASH",total:e.total||0,createdAt:e.createdAt||e.created_at,driverId:e.driverId||(null===(i=e.driver)||void 0===i?void 0:i.id)||null,driverName:(null===(c=e.driver)||void 0===c?void 0:null===(l=c.user)||void 0===l?void 0:l.name)||(null===(s=e.driver)||void 0===s?void 0:s.name)||e.driverName||null,driverPhone:(null===(m=e.driver)||void 0===m?void 0:null===(u=m.user)||void 0===u?void 0:u.phone)||(null===(v=e.driver)||void 0===v?void 0:v.phone)||e.driverPhone||null}});s(r),v.current=t}}catch(e){console.error("Error fetching orders:",e)}finally{m(!1)}},[O,null==d?void 0:d.name,c.length]),A=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!O)return;let t=Date.now();if(e||!(h.length>0)||!(t-y.current<3e5))try{p(!0);let{data:e,error:r}=await i.db.getDrivers(O);if(r){console.error("Failed to fetch drivers:",r);return}if(e){let r=e.map(e=>({id:e.id,name:e.name,phone:e.phone,firmId:e.firmId,firmName:(null==d?void 0:d.name)||"My Firm",status:e.isAvailable?"ONLINE":"OFFLINE",carPlate:e.vehicleNumber||e.carPlate||"N/A",city:e.city||"N/A"}));f(r),y.current=t}}catch(e){console.error("Failed to fetch drivers:",e)}finally{p(!1)}},[O,null==d?void 0:d.name,h.length]),T=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!O)return;let t=Date.now();if(e||!(S.length>0)||!(t-b.current<3e5))try{_(!0);let{data:e,error:r}=await i.db.getClients(O);if(r){console.error("Failed to fetch clients:",r);return}if(e){let r=e.map(e=>{var t,r,n;return{id:e.id,name:e.name,phone:e.phone,email:e.email||"",address:(null===(r=e.addresses)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.address)||"No address",firmId:O,type:"B2C",totalOrders:(null===(n=e._count)||void 0===n?void 0:n.orders)||e.ordersCount||0,revenue:e.totalSpent||0,createdAt:e.createdAt,lastOrderAt:e.lastOrderAt||e.createdAt}});I(r),b.current=t}}catch(e){console.error("Failed to fetch clients:",e)}finally{_(!1)}},[O,S.length]),E=(0,a.useCallback)(async()=>{await Promise.all([k(!0),A(!0),T(!0)])},[k,A,T]);return(0,a.useEffect)(()=>{O&&(v.current=0,y.current=0,b.current=0,s([]),f([]),I([]))},[O]),(0,n.jsx)(l.Provider,{value:{orders:c,ordersLoading:u,fetchOrders:k,drivers:h,driversLoading:g,fetchDrivers:A,clients:S,clientsLoading:N,fetchClients:T,refreshAll:E},children:t})}function c(){let e=(0,a.useContext)(l);if(void 0===e)throw Error("useFirmData must be used within a FirmDataProvider");return e}},2507:function(e,t,r){async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;try{let a=r||localStorage.getItem("authToken"),o={"Content-Type":"application/json",...t.headers};a&&(o.Authorization="Bearer ".concat(a));let i=await fetch("".concat("http://45.92.173.121/api").concat(e),{...t,headers:o}),l=await i.json();if(!i.ok||!l.success){var n;return{data:null,error:Error((null===(n=l.error)||void 0===n?void 0:n.message)||l.message||"Request failed")}}return{data:l.data,error:null}}catch(e){return{data:null,error:e}}}r.d(t,{db:function(){return a}});let a={getFirms:async()=>n("/firms"),getFirmById:async e=>n("/firms/".concat(e)),createFirm:async e=>n("/firms",{method:"POST",body:JSON.stringify(e)}),updateFirm:async(e,t,r)=>n("/firms/".concat(e),{method:"PUT",body:JSON.stringify(t)},null==r?void 0:r.authToken),deleteFirm:async(e,t)=>n("/firms/".concat(e),{method:"DELETE"},null==t?void 0:t.authToken),getProducts:async e=>n("/products".concat(e?"?firmId=".concat(e):"")),createProduct:async(e,t)=>n("/products",{method:"POST",body:JSON.stringify({firmId:e.firm_id,name:e.name,description:e.description,price:e.price,imageUrl:e.image_url,volume:e.volume,inStock:e.in_stock})},null==t?void 0:t.authToken),async updateProduct(e,t,r){let a={};return void 0!==t.name&&(a.name=t.name),void 0!==t.description&&(a.description=t.description),void 0!==t.price&&(a.price=t.price),void 0!==t.image_url&&(a.imageUrl=t.image_url),void 0!==t.volume&&(a.volume=t.volume),void 0!==t.in_stock&&(a.inStock=t.in_stock),n("/products/".concat(e),{method:"PUT",body:JSON.stringify(a)},null==r?void 0:r.authToken)},deleteProduct:async(e,t)=>n("/products/".concat(e),{method:"DELETE"},null==t?void 0:t.authToken),async getOrders(e,t,r){let a=new URLSearchParams;e&&a.append("firmId",e),t&&a.append("branchId",t),r&&a.append("canAccessAllBranches","true");let o=a.toString()?"?".concat(a.toString()):"";return n("/orders".concat(o))},getOrderById:async e=>n("/orders/".concat(e)),updateOrderStatus:async(e,t)=>n("/orders/".concat(e,"/status"),{method:"PUT",body:JSON.stringify({stage:t})}),createOrder:async e=>n("/orders",{method:"POST",body:JSON.stringify(e)}),async getDrivers(e,t,r,a){let o=new URLSearchParams;e&&o.append("firmId",e),t&&o.append("branchId",t),r&&o.append("canAccessAllBranches","true");let i=o.toString()?"?".concat(o.toString()):"";return n("/drivers".concat(i),{},null==a?void 0:a.authToken)},getDriverById:async e=>n("/drivers/".concat(e)),async createDriver(e,t){var r;return n("/drivers",{method:"POST",body:JSON.stringify({firmId:e.firmId,name:e.name,phone:e.phone,vehicleNumber:e.car_plate,carBrand:e.car_brand,carColor:e.car_color,driverNumber:(null===(r=e.driver_number)||void 0===r?void 0:r.toString())||"0"})},null==t?void 0:t.authToken)},async updateDriver(e,t,r){let a={};return void 0!==t.name&&(a.name=t.name),void 0!==t.phone&&(a.phone=t.phone),void 0!==t.car_plate&&(a.vehicleNumber=t.car_plate),void 0!==t.car_brand&&(a.carBrand=t.car_brand),void 0!==t.car_color&&(a.carColor=t.car_color),void 0!==t.is_available&&(a.isAvailable=t.is_available),n("/drivers/".concat(e),{method:"PUT",body:JSON.stringify(a)},null==r?void 0:r.authToken)},deleteDriver:async(e,t)=>n("/drivers/".concat(e),{method:"DELETE"},null==t?void 0:t.authToken),async getClients(e,t,r,a){let o=new URLSearchParams;e&&o.append("firmId",e),t&&o.append("branchId",t),r&&o.append("canAccessAllBranches","true");let i=o.toString()?"?".concat(o.toString()):"";return n("/clients".concat(i),{},null==a?void 0:a.authToken)},async getClientById(e,t,r){let a=new URLSearchParams;t&&a.append("firmId",t);let o=a.toString()?"?".concat(a.toString()):"";return n("/clients/".concat(e).concat(o),{},null==r?void 0:r.authToken)},deleteClient:async(e,t)=>n("/clients/".concat(e),{method:"DELETE"},null==t?void 0:t.authToken)}}}]);